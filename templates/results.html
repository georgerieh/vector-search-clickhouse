<html lang="en">

<head>
    <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet"/>
    <link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet"/>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/leaflet.fullscreen/leaflet.fullscreen.min.js"></script>

    <!--	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"-->
    <!--		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />-->
    <!--	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"-->
    <!--		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>-->
    <!--	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>-->
    <!--	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>-->
    <!--    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>-->
	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css'
		rel='stylesheet' />
	<!-- <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.5.0/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.5.0/maptiler-sdk.css" rel="stylesheet" />
    <script src="https://cdn.maptiler.com/leaflet-maptilersdk/v4.1.0/leaflet-maptilersdk.umd.min.js"></script> -->
	<script src="http://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js">
        <script
            src="https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-markercluster/v0.4.0/leaflet.markercluster.js"></script>

    </script>
	<meta charset="utf-8">
	<title>ClickSearch: Results for search image. Fork by Georg Riekhakainen (georgerieh)</title>
	<style>
		html {
			background: #151515 linear-gradient(101.54deg, #151515 0.61%, #1D1D1D 96.74%);
			font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
			color: white;
			padding: 0;
			margin: 0;
		}

		body {
            background: #111;
            margin: 0;
        }

        .gallery {
            flex: 1 1 40%; /* take half the width */
            min-width: 300px; /* ensure it doesn’t shrink too much */
            height: 400px;
            position: relative; /* needed for absolute controls */
            box-sizing: border-box;
        }

        /*.photo-selection {*/
        /*    position: absolute;*/
        /*    bottom: 10px; !* Adjust as needed to position it above the controls *!*/
        /*    left: 50%;*/
        /*    transform: translateX(-50%);*/
        /*    background: rgba(0, 0, 0, 0.6); !* Semi-transparent background for readability *!*/
        /*    padding: 5px 10px;*/
        /*    border-radius: 5px;*/
        /*    display: flex;*/
        /*    align-items: center;*/
        /*    gap: 8px; !* Space between checkbox and label *!*/
        /*    z-index: 4; !* Ensure it's above other photo layers but below controls *!*/
        /*    opacity: 0; !* Start hidden *!*/
        /*    transition: opacity 0.3s ease-in-out;*/
        /*}*/

        .photo {
            position: absolute;
            top: 0;
            left: 50%;
            width: 50%; /* maybe reduce to 50% */
            height: 100%;
            transform: translateX(-50%);
            background-size: cover;
            background-position: center;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.6s, z-index 0.6s, opacity 0.6s;
            opacity: 0;
        }

        .photo.active {
            transform: translateX(-50%) scale(1);
            z-index: 3;
            opacity: 1;
        }

        .photo.prev {
            transform: translateX(-150%) scale(0.8) rotateY(20deg);
            z-index: 2;
            opacity: 0.7;
        }

        .photo.next {
            transform: translateX(50%) scale(0.8) rotateY(-20deg);
            z-index: 2;
            opacity: 0.7;
        }

        .photo.prev2 {
            transform: translateX(-250%) scale(0.6) rotateY(40deg);
            z-index: 1;
            opacity: 0.4;
        }

        .photo.next2 {
            transform: translateX(150%) scale(0.6) rotateY(-40deg);
            z-index: 1;
            opacity: 0.4;
        }

        .content {
            display: flex;
            gap: 24px;
            padding: 24px;
            flex-wrap: wrap; /* stack on small screens */
        }

        .controls {
            position: absolute;
            bottom: -120px;
            width: 100%;
            text-align: center;
            z-index: 10; /* make sure it’s above photos */
        }

        .controls button {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 10;
        }

        #map-container {
            flex: 1 1 50%;
            min-width: 300px;
            height: 400px; /* same height as gallery */
            padding-left: 36px;
        }

        .photo-selection {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2; /* above the photo-link */
            background: rgba(0, 0, 0, 0.6);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .photo-selection input[type="checkbox"] {
            /* Basic styling for the checkbox itself */
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #fcff74; /* Highlight color for the checkbox */
        }

        .photo-selection label {
            color: white;
            font-size: 14px;
            cursor: pointer;
            user-select: none; /* Prevent text selection on label */
        }

        .photo-link {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1; /* under the checkbox */
        }
        /* Optional: Style for the delete button to make it more prominent */
        #deleteButton {
            background: #fcff74;
            color: #000;
            font-weight: bold;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.3);
            margin: 24px auto; /* Center it below the gallery/map */
            display: block; /* Make it a block element to center with margin: auto */
        }

        #deleteButton:hover {
            background: #f2f24a;
        }

		.container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* two equal columns */
            gap: 24px;
            max-width: 1240px;
            margin: 0 auto;
            padding: 0 24px;
        }

		.title-area {
			background: linear-gradient(180deg, #212121 0%, #1D1D1D 100%);
			border-bottom: 1px solid #282828;
		}

		.title-area .container {
			flex-direction: row;
			justify-content: space-between;
			align-items: center;
			padding: 16px 24px;
		}

		.title-area svg {
			width: 200px;
		}

		.title-area h2 {
			font-size: 20px;
			font-weight: 400;
			margin-top: 0;
		}

		.title-area h2 em {
			color: #fcff74;
			font-style: normal;
		}

		.title-area .results-grid {
			display: flex;

			font-family: 'Courier New', Courier, monospace;
			font-size: 16px;
			font-weight: 500;
		}

		.title-area .results-grid .key {
			padding: 4px 12px;
			border: #313131 1px solid;
			background: #282828;
			width: 256px;
		}

        .images-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* two images per row */
            gap: 24px;
        }

		.title-area .results-grid .value {
			padding: 4px 12px;
			border: #313131 1px solid;
			background: #282828;
			width: 140px;
			color: #fcff74;
		}

		#map {
			height: 400px;
            z-index: 5;
			/* Set the height of the map */
			/* width: 50% ;   Allow the map to take the full width of the cell */
		}

		/* td#map {
				padding: 0; /* Remove any padding from the <td> */
		/* } */
		.grid {
			display: flex;
			flex-wrap: wrap;
			gap: 24px;
			padding: 42px 0;
		}

		.grid-item {
			/* padding: 16px 24px; */
			max-width: 240px;
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			border-radius: 8px;
			border: 1px solid #414141;
			box-shadow: 0px 4px 4px rgba(0, 0, 0, .06), inset 0px 4px 25px rgba(0, 0, 0, .14);
		}

		.grid-item img {
			width: 250px;
			height: 250px;
			object-fit: cover;
			border-radius: 4px;
		}

		.grid-item p {
			margin: 16px 0 0;
		}

		.grid-item em {
			color: #fcff74;
			font-style: normal;
			font-family: 'Courier New', Courier, monospace;
			font-weight: bold;
			font-size: 13px;
			display: block;
			padding-bottom: 8px;
		}

		.grid-item:hover {
			transform: translateY(-1px);
			background: #212121;
			transition: all 400ms cubic-bezier(0.03, 0.98, 0.52, 0.99) 0s;
			cursor: pointer;
		}

		footer {
			font-size: 14px;
			text-align: center;
			color: #606060;
			border-top: 1px solid #212121;
			padding: 24px 0 42px;
		}

		@media screen and (max-width: 824px) {
			.title-area .container {
				flex-direction: column;
				max-width: 98%;
				text-align: center;
			}

			.title-area .results-grid {
				max-width: 94%;
				margin: 0 auto;
				text-align: left;
			}

			.title-area .results-grid .key {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}
		}

		@media screen and (max-width: 520px) {
			.grid-item {
				max-width: 98%;
				margin: 0 auto;
			}
		}

		table {
			width: 100%;
			table-layout: fixed;
			border-collapse: separate;
			border-spacing: 24px;
			/* This adds spacing between your td blocks */
		}

		td {
			padding: 24px;
			vertical-align: top;
		}
	</style>
</head>

<body>
	<header class='title-area'>
		<div class='container'>
            {% if source_image %}
				<div class="grid-item">
					<h2>Results for:</h2>
                    <!--					<img src="{{ url_for('serve_file', filename=source_image) }}" /> -->
                    <img src="{{ url_for('serve_file', filename=source_image) }}"/>
				</div>
            {% elif start_date %}
            <div class="grid-item">
                <h2>Results for memory from {{start_date}}</h2>
            </div>
            {% else %}
            <div class="grid-item">
                <h2>Look for your memories!</h2>
            </div>
            {% endif %}
            <!--			</div>-->
			<div class='section'>
				<form action="/" method="post" enctype="multipart/form-data">
                    <!--                    <input type="hidden" name="start_date" value="{{ session.get('start_date', '') }}">-->
                    <!--                    <input type="hidden" name="end_date" value="{{ session.get('end_date', '') }}">-->
                    <!--                    <input type="hidden" name="limit" value="{{ session.get('limit', '') }}">-->
                    <!--                    <input type="hidden" name="search_text" value="{{ session.get('search_text', '') }}">-->
                    <!--                    <input type="hidden" name="image" value="{{ session.get('saved_image_path', '') }}">-->
                    <input accept="image/*" id="image-in" name="image" type="file"><br><br>

                    <label for="start-date">Start Date:</label>
                    <input id="start-date" name="start_date" type="date"><br><br>

                    <label for="end-date">End Date:</label>
                    <input id="end-date" name="end_date" type="date"><br><br>
                    <input id="limit" name="limit" placeholder="How many photos / days?" type="text"><br><br>

                    <button name="forwardBtn" type="submit">Look up</button>
				</form>
				<br>
				<div class='results-grid'>
					<div class='key'>Table:</div>
					<div class='value'>{{ table }}</div>
				</div>
				<div class='results-grid'>
					<div class='key'>Feature Generation time:</div>
					<div class='value'>{{ gen_time }} sec</div>
				</div>
				<div class='results-grid'>
					<div class='key'>Query time:</div>
					<div class='value'>{{ query_time }} sec</div>
				</div>
			</div>
		</div>
	</header>
    <div class='container'>

        <!-- FIRST COLUMN: The form containing the gallery and delete button -->
        <form action="{{ url_for('delete_photo') }}" class="grid-form" method="POST">
            <div class="gallery">
                {% for image in images %}
                <div class="photo
                    {% if loop.index0 == 0 %}active
                    {% elif loop.index0 == 1 %}next
                    {% elif loop.index0 == 2 %}next2
                    {% elif loop.revindex0 == 0 %}prev
                    {% elif loop.revindex0 == 1 %}prev2{% endif %}"
                     style="background-image: url('{{ url_for('serve_file', filename=image.url) }}');">
                    <a class="photo-link" href="{{ url_for('serve_file', filename=image.url) }}" target="_blank"></a>
                    <div class="photo-selection">
                        <input id="checkbox-{{ loop.index }}" name="image_paths" type="checkbox"
                               value="{{ image.url }}">
                        <label for="checkbox-{{ loop.index }}">Bad photo?</label>
                    </div>
                </div>


                {% endfor %}
                {% if images %}
                <div class="controls">
                    <button id="prevBtn" type="button">Prev</button>
                    <button id="nextBtn" type="button">Next</button>
                </div>
                {% endif %}
                <script>
                    const photos = document.querySelectorAll('.photo');
                    let activeIndex = 0;

                    function updateGallery() {
                        photos.forEach((photo, i) => {
                            photo.className = 'photo';
                            if (i === activeIndex) photo.classList.add('active');
                            else if (i === activeIndex - 1) photo.classList.add('prev');
                            else if (i === activeIndex - 2) photo.classList.add('prev2');
                            else if (i === activeIndex + 1) photo.classList.add('next');
                            else if (i === activeIndex + 2) photo.classList.add('next2');
                        });
                    }

                    document.getElementById('prevBtn').addEventListener('click', () => {
                        activeIndex = (activeIndex - 1 + photos.length) % photos.length;
                        updateGallery();
                    });

                    document.getElementById('nextBtn').addEventListener('click', () => {
                        activeIndex = (activeIndex + 1) % photos.length;
                        updateGallery();
                    });

                    updateGallery();
                </script>
            </div>
            {% if images %}
            <button id="deleteButton" type="submit">Delete Selected</button>
            {% endif %}
        </form>

        <!-- SECOND COLUMN: The map container -->
        <div id="map-container">
            <div id="map">
            </div>
            <script>
                {%
                    if images %
                }
                var clusters = L.markerClusterGroup({
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true
                });
                const map = L.map('map', {fullscreenControl: true}).setView([48.505, 2.33], 3);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 16,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                const imagesData = {
                {
                    images | tojson
                }
                }
                ;
                imagesData.forEach(image => {
                    if (image.lat) {

                        const marker = L.marker([image.lat, image.lon]);
                        clusters.addLayer(marker);
                        marker.bindPopup(`<img src="{{ url_for('serve_file', filename='') }}${image.url}" style="width:150px; height:auto;">`);
                    }
                });
                clusters.addTo(map);
                {%
                    endif %
                }
            </script>
        </div>
    </div>

    <script>
        const selectAll = document.getElementById('select-all');
        if (selectAll) {
            const checkboxes = document.querySelectorAll("input[name='image_paths']");
            selectAll.addEventListener('change', () => {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
            });
        }
    </script>

</body>

</html>